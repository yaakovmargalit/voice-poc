<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020">
  <title>Transcriptions Dashboard</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#7c8db0; --fg:#eaf1ff;
      --accent:#7aa2ff; --accent-2:#42e6a4; --border:#1e2a52;
      --row:#0f1530; --row-hover:#121a3b; --badge:#1c274b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0b1020,#0b1020 40%,#0a0f22 100%);
      color:var(--fg); font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1200px; margin:32px auto; padding:0 16px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;}
    .title{font-weight:700; font-size:22px; display:flex; align-items:center; gap:10px;}
    .title .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 8px var(--accent-2);}
    .pill{padding:6px 10px; border-radius:999px; background:#111a3b; border:1px solid var(--border); color:#cfe0ff}

    .toolbar{background:var(--card); border:1px solid var(--border); padding:12px; border-radius:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .toolbar input,.toolbar button{height:40px; border-radius:10px; border:1px solid var(--border); background:#0c1330; color:var(--fg); padding:0 12px; outline:none}
    .toolbar .url{min-width:380px; flex:1}
    .toolbar .btn{background:var(--accent); border:none; color:#091020; font-weight:700; padding:0 16px; cursor:pointer}
    .toolbar .btn:disabled{opacity:.6; cursor:wait}

    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.25);}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:#121a35; z-index:1; text-align:right; padding:12px; font-weight:600; color:#c7d6ff; border-bottom:1px solid var(--border);}
    tbody tr.data-row{background:var(--row); transition:background .2s; cursor:pointer}
    tbody tr.data-row:hover{background:var(--row-hover)}
    td{padding:12px; border-bottom:1px solid var(--border); vertical-align:top;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
    .muted{color:var(--muted)}
    .status{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-weight:600; font-size:12px; border:1px solid var(--border); background:#1c274b}
    .status.ok{color:#b2ffd9; background:rgba(66,230,164,.08); border-color:rgba(66,230,164,.25)}
    .status.bad{color:#ffd0d0; background:rgba(255,107,107,.08); border-color:rgba(255,107,107,.25)}
    .caret{display:inline-block; font-size:18px; line-height:1}

    .detail-row{background:#0d1333}
    .runs{background:#0b122e; border:1px solid var(--border); border-radius:12px; padding:8px}

    /* ===== Mobile (<=768px): טבלה → כרטיסים ===== */
    @media (max-width:768px){
      .wrap{margin:16px auto}
      .title{font-size:18px}
      .toolbar{flex-direction:column; align-items:stretch; gap:8px}
      .toolbar .url{min-width:0; width:100%}
      .toolbar .btn{width:100%; height:48px; font-size:16px}

      table{display:block}
      thead{display:none}
      tbody{display:block}
      tbody tr.data-row{
        display:block; margin:12px; border:1px solid var(--border); border-radius:14px; padding:10px 12px;
      }
      tbody tr.data-row td{display:flex; gap:8px; align-items:center; border:none; padding:8px 0}
      tbody tr.data-row td[data-label]::before{content:attr(data-label) " "; flex:0 0 auto; min-width:84px; color:var(--muted); font-weight:600}
      /* פרטי ריצות */
      .detail-row{display:none; margin:-6px 12px 12px; border-radius:12px}
      .detail-row td{display:block; padding:0; border:none}
      .runs{padding:10px}
      .runs table{display:block; overflow-x:auto}
      .runs thead{display:none}
      .runs tbody tr{display:block; border-bottom:1px dashed #1c2a55; padding:8px 0}
      .runs tbody td{display:block; padding:4px 0; border:none}
      .runs tbody td::before{content:attr(data-label) " "; color:var(--muted); font-weight:600; margin-inline-end:6px}
    }

    /* ===== Auth overlay (fixed design) ===== */
.overlay{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:rgba(5,8,18,.6); backdrop-filter:blur(6px); z-index:9999;
}
.dialog{
  width:min(520px,92vw); background:var(--card); border:1px solid var(--border);
  border-radius:18px; padding:22px; box-shadow:0 12px 40px rgba(0,0,0,.4);
}
.dialog h2{margin:0 0 8px 0}
.dialog p{margin:0 0 12px 0; color:var(--muted)}
.topline{display:flex; gap:8px; align-items:center; margin-bottom:10px}
.topline .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
.dialog .row{display:flex; gap:10px; align-items:center; margin-top:6px}
.dialog .row input{
  flex:1; height:48px; border-radius:12px; border:1px solid var(--border);
  background:#0c1330; color:var(--fg); padding:0 14px; outline:none;
}
.dialog .row input:focus{border-color:var(--accent)}
.dialog .row button{
  height:48px; border-radius:12px; background:var(--accent);
  border:none; color:#0a0f22; font-weight:800; padding:0 18px; cursor:pointer;
}
.dialog .row button:active{transform:translateY(1px)}
.error{color:#ffb3b3; margin-top:8px; min-height:20px}
.hint{font-size:12px; color:#7e8db0; margin-top:10px}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="dot"></span> לוח תמלולים (Transcriptions)</div>
      <div class="pill" id="countPill">—</div>
    </header>

    <div class="toolbar">
      <input disabled id="urlInput" class="url" type="url"
             value="https://q7vo754nhmb3wl33a2des4txaq0xwzdh.lambda-url.eu-central-1.on.aws/" />
      <button id="refreshBtn" class="btn"><span class="loader" style="display:none" id="btnSpin"></span><span id="btnTxt">טען נתונים</span></button>
    </div>

    <div class="card" style="margin-top:16px;">
      <table id="mainTable" aria-label="Transcriptions list">
        <thead>
          <tr>
            <th style="width:36px;"></th>
            <th>File ID</th>
            <th>שפה</th>
            <th>מס׳ ריצות</th>
            <th>נוצר</th>
            <th>עודכן</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="footer-actions" style="display:flex;justify-content:center;padding:16px">
        <button id="loadMoreBtn" class="toolbar btn" style="display:none">טען עוד</button>
      </div>
    </div>
  </div>

  <!-- Password Overlay -->
<!-- Password Overlay -->
<div class="overlay" id="authOverlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="topline">
        <span class="dot"></span>
        <strong>נדרש קוד גישה</strong>
      </div>
      <h2>כניסה מאובטחת</h2>
      <p>הזן את קוד הגישה כדי לצפות ברשימות התמלול.</p>
      <div class="row">
        <input id="codeInput" type="password" placeholder="הכנס קוד גישה" autocomplete="current-password" />
        <button id="enterBtn">כניסה</button>
      </div>
      <div class="error" id="authError"></div>
      <div class="hint">הקוד נשלח כ־Query; לא נשמר בדפדפן.</div>
    </div>
  </div>
  

  <script>
    // === State ===
    const state = { accessCode:null, nextToken:null, itemsSeen:0, lastUrl:'' };

    // === Elements ===
    const urlInput   = document.getElementById('urlInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const btnSpin    = document.getElementById('btnSpin');
    const btnTxt     = document.getElementById('btnTxt');
    const tbody      = document.getElementById('tbody');
    const loadMoreBtn= document.getElementById('loadMoreBtn');
    const countPill  = document.getElementById('countPill');

    const authOverlay= document.getElementById('authOverlay');
    const codeInput  = document.getElementById('codeInput');
    const enterBtn   = document.getElementById('enterBtn');
    const authError  = document.getElementById('authError');

    // === Utils ===
    function fmtDate(s){
      if (!s) return '—';
      try {
        const d = new Date(s);
        return new Intl.DateTimeFormat('he-IL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(d);
      } catch { return s; }
    }
    function esc(t){ const div=document.createElement('div'); div.textContent=String(t ?? ''); return div.innerHTML; }
    function shortId(id){ return id ? id.slice(0,10) + '…' + id.slice(-6) : '—'; }
    function setBusy(b){ refreshBtn.disabled=b; btnSpin.style.display=b?'inline-block':'none'; btnTxt.textContent=b?'טוען…':'טען נתונים'; }
    function badgeStatus(status){ const ok=String(status).toUpperCase()==='COMPLETED'; return `<span class="status ${ok?'ok':'bad'}">${esc(status)}</span>`; }

    // === Render ===
    function renderItems(items,{append=false}={}){
      if (!append){ tbody.innerHTML=''; state.itemsSeen=0; }
      const frag=document.createDocumentFragment();
      items.forEach(it=>{
        state.itemsSeen++;
        // main row
        const tr=document.createElement('tr');
        tr.className='data-row';
        tr.dataset.fileId=it.fileId;
        tr.innerHTML=`
          <td data-label=""><span class="caret">▸</span></td>
          <td data-label="File ID" class="mono" title="${esc(it.fileId)}">${esc(shortId(it.fileId))}</td>
          <td data-label="שפה">${esc(it.languageCode || '—')}</td>
          <td data-label="מס׳ ריצות"><strong>${Number(it.runsCount || 0)}</strong></td>
          <td data-label="נוצר" class="muted">${fmtDate(it.firstSeen)}</td>
          <td data-label="עודכן" class="muted">${fmtDate(it.updatedAt)}</td>
        `;

        // details row (runs)
        const dr=document.createElement('tr');
        dr.className='detail-row';
        dr.dataset.fileId=it.fileId;

        const runs=Array.isArray(it.runs)?it.runs:[];
        const rows=runs.map((r,i)=>`
          <tr>
            <td data-label="#">${i+1}</td>
            <td data-label="Job" class="mono">${esc(r.jobName || '—')}</td>
            <td data-label="סטטוס">${badgeStatus(r.status || '—')}</td>
            <td data-label="זמן" class="muted">${fmtDate(r.timestamp)}</td>
            <td data-label="טקסט"><div class="text">${esc(r.text ?? r.textPreview ?? '') || '<span class="muted">—</span>'}</div></td>
          </tr>
        `).join('');

        dr.innerHTML = `<td colspan="6">
          <div class="runs">
            <table>
              <thead><tr><th style="width:80px;">#</th><th>Job</th><th>סטטוס</th><th>זמן</th><th>טקסט</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </td>`;
        dr.style.display='none';
        dr.dataset.open = '0';

        frag.appendChild(tr); frag.appendChild(dr);
      });
      tbody.appendChild(frag);
      countPill.textContent=`מופיעים: ${state.itemsSeen}`;
    }

    function toggleRow(fileId){
      const main=[...tbody.querySelectorAll('tr.data-row')].find(r=>r.dataset.fileId===fileId);
      const detail=[...tbody.querySelectorAll('tr.detail-row')].find(r=>r.dataset.fileId===fileId);
      if (!main||!detail) return;
      const caret = main.querySelector('.caret');
      const isOpen = detail.dataset.open === '1';
      const isMobile = window.matchMedia('(max-width: 768px)').matches;

      if (isOpen){
        detail.style.display = 'none';
        detail.dataset.open = '0';
        if (caret) caret.textContent = '▸';
      } else {
        detail.style.display = isMobile ? 'block' : 'table-row'; // ✅ עוקף את CSS של מובייל
        detail.dataset.open = '1';
        if (caret) caret.textContent = '▾';
      }
    }

    // === Data loading ===
    async function fetchPage({append=false, token=null}={}){
      const base=urlInput.value.trim();
      if (!base) return alert('נא להזין URL של הפונקציה');
      state.lastUrl=base;

      const params=new URLSearchParams({
        limit:'50', includeRuns:'true', includeText:'true', fullText:'true',
        code: state.accessCode || '' // שולח ב-query → אין preflight
      });
      if (token) params.set('nextToken', token);

      const url=base.replace(/\/+$/,'/')+'?'+params.toString();
      setBusy(true);
      try{
        const res=await fetch(url,{ headers:{ 'Accept':'application/json' } });
        if (res.status===401){ showAuth('קוד לא נכון. נסה מחדש.'); return; }
        if (!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status}: ${t||res.statusText}`); }
        const data=await res.json();
        const items=Array.isArray(data.items)?data.items:[];
        renderItems(items,{append});
        state.nextToken=data.nextToken||null;
        loadMoreBtn.style.display=state.nextToken?'':'none';
      }catch(e){
        console.error(e); alert('שגיאה בטעינת נתונים: '+(e.message||e));
      }finally{ setBusy(false); }
    }

    // === Auth overlay ===
    function showAuth(msg=''){ authError.textContent=msg; authOverlay.style.display='flex'; codeInput.value=''; codeInput.focus(); }
    function hideAuth(){ authOverlay.style.display='none'; }

    // === Listeners ===
    enterBtn.addEventListener('click', ()=>{
      const code=codeInput.value.trim();
      if (!code){ authError.textContent='נא להזין קוד'; return; }
      state.accessCode=code; hideAuth(); fetchPage({append:false});
    });
    codeInput.addEventListener('keydown', e=>{ if (e.key==='Enter') enterBtn.click(); });

    refreshBtn.addEventListener('click', ()=> fetchPage({append:false}));
    loadMoreBtn.addEventListener('click', ()=> fetchPage({append:true, token:state.nextToken}));

    tbody.addEventListener('click', (e)=>{
      const tr=e.target.closest('tr.data-row');
      if (tr) toggleRow(tr.dataset.fileId);
    });

    // First render
    showAuth();
  </script>
</body>
</html>
