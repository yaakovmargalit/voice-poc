<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transcriptions Dashboard</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#7c8db0;
      --fg:#eaf1ff;
      --accent:#7aa2ff;
      --accent-2:#42e6a4;
      --danger:#ff6b6b;
      --border:#1e2a52;
      --row:#0f1530;
      --row-hover:#121a3b;
      --badge:#1c274b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0b1020, #0b1020 40%, #0a0f22 100%);
      color:var(--fg); font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:32px auto; padding:0 16px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;
    }
    .title{
      font-weight:700; font-size:22px; letter-spacing:.3px; display:flex; align-items:center; gap:10px;
    }
    .title .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 8px var(--accent-2);}
    .toolbar{
      background:var(--card); border:1px solid var(--border);
      padding:12px; border-radius:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .toolbar input,.toolbar button{
      height:40px; border-radius:10px; border:1px solid var(--border); background:#0c1330; color:var(--fg);
      padding:0 12px; outline:none;
    }
    .toolbar input:focus{border-color:var(--accent)}
    .toolbar .url{min-width:380px; flex:1}
    .toolbar .btn{background:var(--accent); border:none; color:#091020; font-weight:700; padding:0 16px; cursor:pointer}
    .toolbar .btn:disabled{opacity:.6; cursor:wait}
    .toolbar .tag{padding:6px 10px; border-radius:999px; background:var(--badge); color:var(--muted); border:1px solid var(--border);}

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden;
      box-shadow:0 8px 30px rgba(0,0,0,.25);
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      position:sticky; top:0; background:#121a35; z-index:1;
      text-align:right; padding:12px; font-weight:600; color:#c7d6ff; border-bottom:1px solid var(--border);
    }
    tbody tr.data-row{background:var(--row); transition:background .2s}
    tbody tr.data-row:hover{background:var(--row-hover)}
    td{
      padding:12px; border-bottom:1px solid var(--border); vertical-align:top;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:var(--muted)}
    .status{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-weight:600; font-size:12px; border:1px solid var(--border); background:var(--badge)}
    .status.ok{color:#b2ffd9; background:rgba(66,230,164,.08); border-color:rgba(66,230,164,.25)}
    .status.bad{color:#ffd0d0; background:rgba(255,107,107,.08); border-color:rgba(255,107,107,.25)}
    .copy-btn{background:#0c1330;border:1px solid var(--border);color:var(--fg);padding:6px 10px;border-radius:8px;cursor:pointer}
    .copy-btn:hover{border-color:var(--accent)}
    .caret{display:inline-block; transition:transform .2s ease; transform:rotate(0deg)}
    .expanded .caret{transform:rotate(-90deg)}
    .detail-row{background:#0d1333}
    .runs{background:#0b122e; border:1px solid var(--border); border-radius:12px; padding:8px}
    .runs table{width:100%}
    .runs thead th{background:transparent}
    .runs td,.runs th{border-bottom:1px dashed #1c2a55}
    .runs .text{white-space:pre-wrap}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#17234a; border:1px solid #243569; color:#cfe0ff; font-size:12px}
    .pill{padding:6px 10px; border-radius:999px; background:#111a3b; border:1px solid var(--border); color:#cfe0ff}
    .footer-actions{display:flex; justify-content:center; padding:16px}
    .load-more{background:transparent; border:1px solid var(--accent); color:var(--fg); border-radius:999px; padding:10px 16px; cursor:pointer}
    .loader{width:18px;height:18px;border:3px solid #2a396b;border-top-color:var(--accent);border-radius:50%;display:inline-block;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Password overlay */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(5,8,18,.6); backdrop-filter: blur(6px); z-index:9999;
    }
    .dialog{
      width:min(520px,92vw); background:var(--card); border:1px solid var(--border); border-radius:18px; padding:22px;
      box-shadow:0 12px 40px rgba(0,0,0,.4);
    }
    .dialog h2{margin:0 0 8px 0}
    .dialog p{margin:0 0 12px 0; color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center}
    .row input{flex:1; height:44px; border-radius:10px; border:1px solid var(--border); background:#0c1330; color:var(--fg); padding:0 12px}
    .row button{height:44px; border-radius:10px; background:var(--accent); border:none; color:#0a0f22; font-weight:800; padding:0 16px; cursor:pointer}
    .error{color:#ffb3b3; margin-top:8px; min-height:20px}
    .hint{font-size:12px; color:#7e8db0; margin-top:10px}
    .topline{display:flex; gap:8px; align-items:center; margin-bottom:10px}
    .topline .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="dot"></span> לוח תמלולים (Transcriptions)</div>
      <div class="pill" id="countPill">—</div>
    </header>

    <div class="toolbar">
      <span class="tag">Function URL</span>
      <input id="urlInput" class="url" type="url"
             value="https://q7vo754nhmb3wl33a2des4txaq0xwzdh.lambda-url.eu-central-1.on.aws/"
             placeholder="https://...lambda-url...on.aws/" />
      <button id="refreshBtn" class="btn"><span class="loader" style="display:none" id="btnSpin"></span><span id="btnTxt">טען נתונים</span></button>
      <span class="tag" title="מציג את כל הריצות של כל קובץ">includeRuns</span>
      <span class="tag">fullText</span>
    </div>

    <div class="card" style="margin-top:16px;">
      <table id="mainTable" aria-label="Transcriptions list">
        <thead>
          <tr>
            <th style="width:36px;"></th>
            <th>File ID</th>
            <th>שפה</th>
            <th>מס׳ ריצות</th>
            <th>נוצר</th>
            <th>עודכן</th>
            <th>פעולות</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- Rows injected here -->
        </tbody>
      </table>
      <div class="footer-actions">
        <button id="loadMoreBtn" class="load-more" style="display:none">טען עוד</button>
      </div>
    </div>
  </div>

  <!-- Password Overlay -->
  <div class="overlay" id="authOverlay" role="dialog" aria-modal="true">
    <div class="dialog">
      <div class="topline">
        <span class="dot"></span>
        <strong>נדרש קוד גישה</strong>
      </div>
      <h2>כניסה מאובטחת</h2>
      <p>הזן את קוד הגישה כדי לצפות ברשימות התמלול.</p>
      <div class="row">
        <input id="codeInput" type="password" placeholder="הכנס קוד גישה" autocomplete="current-password" />
        <button id="enterBtn">כניסה</button>
      </div>
      <div class="error" id="authError"></div>
      <div class="hint">הקוד נשלח בכותרת <code class="mono">X-Access-Code</code>. הוא לא נשמר קבוע בדפדפן.</div>
    </div>
  </div>

  <script>
    // === Configuration & State ===
    const state = {
      accessCode: null,
      nextToken: null,
      itemsSeen: 0,
      lastUrl: '',
    };

    // === Elements ===
    const urlInput = document.getElementById('urlInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const btnSpin = document.getElementById('btnSpin');
    const btnTxt = document.getElementById('btnTxt');
    const tbody = document.getElementById('tbody');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const countPill = document.getElementById('countPill');

    const authOverlay = document.getElementById('authOverlay');
    const codeInput = document.getElementById('codeInput');
    const enterBtn = document.getElementById('enterBtn');
    const authError = document.getElementById('authError');

    // === Utils ===
    function fmtDate(s){
      if (!s) return '—';
      try {
        const d = new Date(s);
        return new Intl.DateTimeFormat('he-IL', {
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', second:'2-digit'
        }).format(d);
      } catch { return s; }
    }
    function esc(t){ const div=document.createElement('div'); div.textContent=String(t ?? ''); return div.innerHTML; }
    function shortId(id){ return id ? id.slice(0,10) + '…' + id.slice(-6) : '—'; }
    function setBusy(b){
      refreshBtn.disabled = b;
      btnSpin.style.display = b ? 'inline-block' : 'none';
      btnTxt.textContent = b ? 'טוען…' : 'טען נתונים';
    }
    function badgeStatus(status){
      const ok = String(status).toUpperCase() === 'COMPLETED';
      return `<span class="status ${ok?'ok':'bad'}">${esc(status)}</span>`;
    }
    function copy(text){
      navigator.clipboard.writeText(text).then(()=>{
        alert('הועתק ✅');
      },()=>{ alert('נכשל להעתיק'); });
    }

    // === Rendering ===
    function renderItems(items, {append=false}={}){
      if (!append) { tbody.innerHTML=''; state.itemsSeen = 0; }
      const frag = document.createDocumentFragment();
      items.forEach((it, idx) => {
        state.itemsSeen++;
        // Main row
        const tr = document.createElement('tr');
        tr.className = 'data-row';
        tr.dataset.fileId = it.fileId;

        tr.innerHTML = `
          <td><span class="caret">▸</span></td>
          <td class="mono" title="${esc(it.fileId)}">${esc(shortId(it.fileId))}</td>
          <td>${esc(it.languageCode || '—')}</td>
          <td><strong>${Number(it.runsCount || 0)}</strong></td>
          <td class="muted">${fmtDate(it.firstSeen)}</td>
          <td class="muted">${fmtDate(it.updatedAt)}</td>
          <td>
            <button class="copy-btn" data-copy="${esc(it.fileId)}" title="העתק File ID">העתק ID</button>
            ${it.s3Key ? `<span class="badge" title="S3 Key">${esc(it.s3Key)}</span>` : ''}
          </td>
        `;

        // Detail row (runs table)
        const dr = document.createElement('tr');
        dr.className = 'detail-row';
        dr.dataset.fileId = it.fileId;
        const runs = Array.isArray(it.runs) ? it.runs : [];
        const runsTable = `
          <div class="runs">
            <table>
              <thead>
                <tr>
                  <th style="width:80px;">#</th>
                  <th>Job</th>
                  <th>סטטוס</th>
                  <th>זמן</th>
                  <th>טקסט</th>
                </tr>
              </thead>
              <tbody>
                ${runs.map((r, i) => {
                  const full = r.text ?? '';
                  const preview = r.textPreview ?? '';
                  const hasFull = !!full;
                  const content = hasFull ? esc(full) : esc(preview);
                  const runId = `${it.fileId}-${i}`;
                  return `
                    <tr>
                      <td class="mono">${i+1}</td>
                      <td class="mono">${esc(r.jobName || '—')}</td>
                      <td>${badgeStatus(r.status || '—')}</td>
                      <td class="muted">${fmtDate(r.timestamp)}</td>
                      <td>
                        ${hasFull
                          ? `<details><summary>הצג/הסתר טקסט</summary><div class="text">${content}</div></details>`
                          : `<div class="text">${content || '<span class="muted">—</span>'}</div>`
                        }
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        dr.innerHTML = `<td colspan="7">${runsTable}</td>`;
        dr.style.display = 'none';

        frag.appendChild(tr);
        frag.appendChild(dr);
      });
      tbody.appendChild(frag);
      countPill.textContent = `מופיעים: ${state.itemsSeen}`;
    }

    function toggleRow(fileId){
      const main = [...tbody.querySelectorAll('tr.data-row')].find(r => r.dataset.fileId===fileId);
      const detail = [...tbody.querySelectorAll('tr.detail-row')].find(r => r.dataset.fileId===fileId);
      if (!main || !detail) return;
      const showing = detail.style.display !== 'none';
      detail.style.display = showing ? 'none' : '';
      main.classList.toggle('expanded', !showing);
    }

    // === Data loading ===
    async function fetchPage({append=false, token=null}={}){
      const base = urlInput.value.trim();
      if (!base) return alert('נא להזין URL של הפונקציה');
      state.lastUrl = base;

      const params = new URLSearchParams({
        limit: '50',
        includeRuns: 'true',
        includeText: 'true',
        fullText: 'true',
      });
      if (token) params.set('nextToken', token);

      const url = base.replace(/\/+$/,'/') + '?' + params.toString();
      setBusy(true);
      try {
        const res = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'X-Access-Code': state.accessCode || ''
          }
        });
        if (res.status === 401) {
          // Re-authenticate
          showAuth('קוד לא נכון. נסה מחדש.');
          return;
        }
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status}: ${t || res.statusText}`);
        }
        const data = await res.json();
        // Normalize items to the shape we expect
        const items = Array.isArray(data.items) ? data.items : [];
        renderItems(items, {append});
        // handle pagination
        state.nextToken = data.nextToken || null;
        loadMoreBtn.style.display = state.nextToken ? '' : 'none';
      } catch (e){
        console.error(e);
        alert('שגיאה בטעינת נתונים: ' + (e.message || e));
      } finally {
        setBusy(false);
      }
    }

    // === Auth overlay ===
    function showAuth(msg=''){
      authError.textContent = msg;
      authOverlay.style.display = 'flex';
      codeInput.value = '';
      codeInput.focus();
    }
    function hideAuth(){
      authOverlay.style.display = 'none';
    }

    // === Listeners ===
    enterBtn.addEventListener('click', () => {
      const code = codeInput.value.trim();
      if (!code) { authError.textContent = 'נא להזין קוד'; return; }
      state.accessCode = code; // keep only in memory
      hideAuth();
      fetchPage({append:false});
    });
    codeInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') enterBtn.click(); });

    refreshBtn.addEventListener('click', ()=> fetchPage({append:false}));
    loadMoreBtn.addEventListener('click', ()=> fetchPage({append:true, token: state.nextToken}));

    tbody.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr.data-row');
      if (tr) {
        // Ignore clicks on buttons
        const isBtn = e.target.closest('button'); if (isBtn) return;
        toggleRow(tr.dataset.fileId);
      }
      const copyBtn = e.target.closest('button.copy-btn');
      if (copyBtn) copy(copyBtn.dataset.copy);
    });

    // First render → show auth
    showAuth();
  </script>
</body>
</html>
