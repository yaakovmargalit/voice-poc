<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Voice to Text</title>
  <style>
    :root {
      --brand:#5563DE;
      --brand-dark:#4051b5;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #74ABE2, var(--brand));
      color: #333;
      direction: rtl;
    }
    .container {
      text-align: center;
      width: 90%;
      max-width: 680px;
      background: #fff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
      margin: 10px;
    }
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    button {
      background: var(--brand);
      color: white;
      border: none;
      padding: 1rem 1.25rem;
      font-size: 1.05rem;
      border-radius: 50px;
      cursor: pointer;
      transition: background 0.3s, transform .05s ease-in-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }
    button:hover { background: var(--brand-dark); }
    button:active { transform: translateY(1px); }
    .secondary { background:#e9ecff; color:#223; }
    .secondary:hover { background:#dce1ff; }
    .recording { animation: pulse 1s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(85, 99, 222, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(85, 99, 222, 0); }
      100% { box-shadow: 0 0 0 0 rgba(85, 99, 222, 0); }
    }
    #status {
      min-height: 1.25rem;
      color:#202124;
      font-size: .95rem;
    }
    progress {
      width: 100%;
      height: 10px;
      accent-color: var(--brand);
      display: none;
    }
    #transcript {
      width: 100%;
      min-height: 160px;
      border-radius: 12px;
      border: 1px solid #ccc;
      padding: 1rem;
      font-size: 1rem;
      resize: vertical;
      background: #f9f9f9;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    @media (max-width: 520px) {
      .actions { grid-template-columns: 1fr; }
      button { width: 100%; font-size: 1rem; }
    }

    /* ××¡×š ×˜×¢×™× ×” ××œ× */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    .overlay-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 28px;
      width: min(90vw, 520px);
      text-align: center;
      box-shadow: 0 12px 32px rgba(0,0,0,.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .spinner {
      width: 44px; height: 44px; margin: 0 auto 6px auto;
      border: 5px solid #e6e8ff;
      border-top: 5px solid var(--brand);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .overlay h3 { margin: 6px 0 0; }
    .overlay p { margin: 0; color:#555; }
    .overlay .small { font-size: .9rem; color:#666; }
    .overlay progress { display:block; height:12px; }

    .file-hint {
      font-size:.9rem; color:#555;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="actions">
      <button id="recordBtn" title="×”×ª×—×œ×ª ×”×§×œ×˜×” ××”××™×§×¨×•×¤×•×Ÿ">ğŸ™ï¸ ×”×ª×—×œ ×”×§×œ×˜×”</button>

      <!-- ×›×¤×ª×•×¨ ×”×¢×œ××ª ZIP -->
      <button id="zipBtn" class="secondary" title="×”×¢×œ×” ZIP ×©×œ ×§×‘×¦×™ webm ×œ×ª××œ×•×œ">ğŸ“¦ ×”×¢×œ××ª ZIP ×œ×ª××œ×•×œ</button>
      <input type="file" id="zipInput" accept=".zip" style="display:none" />
    </div>

    <div id="status"></div>
    <progress id="overallProgress" value="0" max="100"></progress>
    <div class="file-hint">× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×§×•×‘×¥ â€ZIPâ€ ×©××›×™×œ ×§×‘×¦×™ â€.webmâ€. ×›×œ ×§×•×‘×¥ ×™×¢×•×‘×“ ×‘×ª×•×¨×•.</div>

    <textarea id="transcript" placeholder="×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ..." readonly></textarea>
  </div>

  <!-- ××¡×š ×˜×¢×™× ×” -->
  <div class="overlay" id="overlay" aria-live="polite" aria-busy="true">
    <div class="overlay-content">
      <div class="spinner" role="status" aria-label="××¢×‘×“..."></div>
      <h3>××¢×‘×“ ×§×‘×¦×™×â€¦</h3>
      <p>× × ×œ× ×œ×¡×’×•×¨ ××ª ×”×“×£</p>
      <progress id="overlayProgress" value="0" max="100"></progress>
      <div class="small" id="overlayDetail"></div>
    </div>
  </div>

  <!-- JSZip ×œ× ×™×ª×•×— ZIP ×‘×¦×“ ×”×œ×§×•×— -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const recordBtn = document.getElementById('recordBtn');
const zipBtn = document.getElementById('zipBtn');
const zipInput = document.getElementById('zipInput');

const transcriptEl = document.getElementById('transcript');
const statusEl = document.getElementById('status');
const overallProgress = document.getElementById('overallProgress');

const overlay = document.getElementById('overlay');
const overlayProgress = document.getElementById('overlayProgress');
const overlayDetail = document.getElementById('overlayDetail');

let mediaRecorder;
let audioChunks = [];

/** ×¤×•× ×§×¦×™×™×ª ×©×™×¨×•×ª: ×©×œ×™×—×ª Blob ×©×œ ××•×“×™×• ×œ×ª××œ×•×œ ×•××—×–×™×¨×” ×˜×§×¡×˜ */
async function sendAudioForTranscription(audioBlob) {
  // ×××™×¨ ×œ-base64 ×‘×œ×™ ×œ×¢×œ×•×ª ×œ×©×¨×ª ×œ×¤× ×™ (×›××• ×”×œ×•×’×™×§×” ×”×§×™×™××ª)
  const base64Audio = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onloadend = () => {
      const res = (reader.result || '').toString();
      resolve(res.split(',')[1]); // ××•×¨×™×“ ××ª ×”-prefix
    };
    reader.readAsDataURL(audioBlob);
  });

  const endpoint = 'https://a6wxeeaaevuch7dkfbnbkhajiy0lvfin.lambda-url.eu-central-1.on.aws/';
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ audio: base64Audio })
  });

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error(`×©×’×™××” ××”×©×¨×ª (${res.status}): ${text || '×œ× ×™×“×•×¢'}`);
  }

  const data = await res.json().catch(() => ({}));
  if (data.error && !data.text) {
    throw new Error(data.error);
  }
  return data.text || '';
}

/** UI Helpers */
function showOverlay(show) {
  overlay.style.display = show ? 'flex' : 'none';
  // ×‘×–××Ÿ ×©×”××•×‘×¨×œ×™×™ ×¤×ª×•×— â€“ ×œ×× ×•×¢ ×’×œ×™×œ×” ×××—×•×¨×™ ×”××¡×š
  document.body.style.overflow = show ? 'hidden' : '';
}
function setOverlayProgress(percent, detailText='') {
  overlayProgress.value = Math.max(0, Math.min(100, percent));
  overlayDetail.textContent = detailText;
}
function resetProgressBars() {
  overallProgress.value = 0;
  overallProgress.style.display = 'none';
  setOverlayProgress(0, '');
}

/** ×”×§×œ×˜×” ××”××™×§×¨×•×¤×•×Ÿ (×§×™×™×, ×¢× ×¨×™×¤×§×˜×•×¨ ×§×˜×Ÿ ×œ×©×™××•×© ×‘-sendAudioForTranscription) */
recordBtn.addEventListener('click', async () => {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = [];
        statusEl.textContent = "××¢×œ×” ×•×××ª×™×Ÿ ×œ×ª××œ×•×œ...";
        transcriptEl.value = "";

        try {
          const text = await sendAudioForTranscription(audioBlob);
          transcriptEl.value = text || '(×œ× ×”×ª×§×‘×œ ×˜×§×¡×˜)';
          statusEl.textContent = "×”×ª××œ×•×œ ×”×•×©×œ×!";
        } catch (err) {
          console.error(err);
          transcriptEl.value = "";
          statusEl.textContent = "×©×’×™××” ×‘×”×ª×§×©×¨×•×ª ×¢× ×”×©×¨×ª";
        } finally {
          recordBtn.textContent = "×”×ª×—×œ ×”×§×œ×˜×”";
          recordBtn.classList.remove('recording');
        }
      };

      mediaRecorder.start();
      recordBtn.classList.add('recording');
      recordBtn.textContent = "×”×§×œ×˜×” ×‘×¤×¢×•×œ×” - ×œ×—×¥ ×œ×¢×¦×™×¨×”";
      statusEl.textContent = "×”×§×œ×˜×” ×‘×¤×¢×•×œ×”...";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××™×§×¨×•×¤×•×Ÿ";
    }
  } else if (mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    recordBtn.textContent = "××¢×‘×“ ××ª ×”×”×§×œ×˜×”...";
    statusEl.textContent = "×¢×¦×™×¨×ª ×”×§×œ×˜×”...";
  }
});

/** ×”×¢×œ××ª ZIP */
zipBtn.addEventListener('click', () => zipInput.click());

zipInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  await processZipFile(file);
  // ××™×¤×•×¡ ×”×‘×—×™×¨×” â€“ ×©×™××¤×©×¨ ×‘×—×™×¨×” ××—×“×© ×©×œ ××•×ª×• ×§×•×‘×¥ ×× ×¦×¨×™×š
  zipInput.value = '';
});

/** ×¢×™×‘×•×“ ZIP: ×©×œ×™×¤×” ×¡×“×¨×ª×™×ª ×©×œ ×›×œ ×§×•×‘×¥ webm ×•×©×œ×™×—×ª×• ×œ×ª××œ×•×œ */
async function processZipFile(zipFile) {
  transcriptEl.value = '';
  statusEl.textContent = '×˜×•×¢×Ÿ ZIPâ€¦';
  overallProgress.style.display = 'block';
  overallProgress.value = 0;
  showOverlay(true);
  setOverlayProgress(0, '×¤×•×ª×— ××¨×›×™×•×Ÿâ€¦');

  try {
    const zip = await JSZip.loadAsync(zipFile);
    // ×œ××¡×•×£ ×¨×§ ×§×‘×¦×™ .webm (×œ×œ× ×ª×™×§×™×•×ª)
    const entries = Object.values(zip.files)
      .filter(f => !f.dir && /\.webm$/i.test(f.name));

    if (entries.length === 0) {
      statusEl.textContent = '×œ× × ××¦××• ×§×‘×¦×™ â€.webmâ€ ×‘××¨×›×™×•×Ÿ.';
      showOverlay(false);
      resetProgressBars();
      return;
    }

    let completed = 0;
    const total = entries.length;

    // ×¢×™×‘×•×“ ×¡×“×¨×ª×™ (× ×× ×¢ ××¢×•××¡×™×/Rate Limit)
    for (const entry of entries) {
      setOverlayProgress(
        Math.round((completed / total) * 100),
        `××¢×‘×“: ${entry.name} (${completed}/${total})`
      );

      // ×§×‘×œ×ª Blob ×©×œ ×›×œ ×§×•×‘×¥
      const arrayBuffer = await entry.async('arraybuffer');
      const blob = new Blob([arrayBuffer], { type: 'audio/webm' });

      // ×©×œ×™×—×” ×œ×ª××œ×•×œ
      try {
        const text = await sendAudioForTranscription(blob);

        // ×›×ª×™×‘×” ×œ×ª×•×¦××” (××¦×˜×‘×¨, ×¢× ×©× ×”×§×•×‘×¥)
        transcriptEl.value += `\nğŸ“„ ${entry.name}\n${text || '(×œ× ×”×ª×§×‘×œ ×˜×§×¡×˜)'}\n${'-'.repeat(30)}\n`;
      } catch (err) {
        console.error('×©×’×™××” ×‘×ª××œ×•×œ ×§×•×‘×¥', entry.name, err);
        transcriptEl.value += `\nğŸ“„ ${entry.name}\n×©×’×™××” ×‘×ª××œ×•×œ: ${err.message}\n${'-'.repeat(30)}\n`;
      }

      completed++;
      const percent = Math.round((completed / total) * 100);
      overallProgress.value = percent;
      setOverlayProgress(percent, `×¢×•×‘×“â€¦ ${completed}/${total}`);
    }

    statusEl.textContent = `×”×¢×™×‘×•×“ ×”×•×©×œ× (${completed}/${total}).`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = '×©×’×™××” ×‘×§×¨×™××ª ×”-ZIP. ×•×“× ×©×”×§×•×‘×¥ ×ª×§×™×Ÿ.';
  } finally {
    showOverlay(false);
    setOverlayProgress(100, '×”×¡×ª×™×™×');
    setTimeout(resetProgressBars, 800);
  }
}
</script>

</body>
</html>
